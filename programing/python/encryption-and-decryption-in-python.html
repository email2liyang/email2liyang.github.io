<!DOCTYPE html>
<html>
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147718386-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147718386-1');
</script>


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mind - encryption and decryption in python</title>
  
    
  
  <meta name="description" content="Recently I need to design a way to store and transfer sensitive data in a secure way, as the data is sensitive, no one could see the data except the owner, our system is only granted to get the plain text at run time, when storing or transferring the data, it must remains encrypted and the password for encryption shoul">
  
  
  
  <link rel="shortcut icon" href="../../images/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../../images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon/favicon-16x16.png">
  <link rel="manifest" href="../../images/favicon/site.webmanifest">
  <link rel="mask-icon" href="../../images/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  
  <link href='../../styles/main.min.css?v=1642818827307' rel='stylesheet' type='text/css'>
  
  <style></style>

  
<script>
  var doc_layout_plugin = {
    enabled: true
  };
</script>
</head>
<body>


<script async type="text/javascript" language="javascript" src="../../plugins/plugins.nocache.js?v=1642818827307"></script>
<iframe src="javascript:''" id="__gwt_historyFrame"
        style="position:absolute;width:0;height:0;border:0" tabIndex="-1"></iframe>
<!--[if lt IE 8]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<div class="nav b5">
  <div class="nav__content max-width-md">
    <div class="nav__content__left">
      <div class="nav__header">
        <a class="logo" href="../../index.html" title="Home">
          <img class="logo__img" src="../../images/logo.png" alt="VIP">
          <span class="logo__name">Mind</span><span class="superscript">me</span>
        </a>
        <label id="menu-icon" class="nav__menu-toggle" for="menu-toggle-1">
          <svg class="nav__menu-icon" viewBox="0 0 448 512"><rect y="398" width="448" height="36"/><rect y="78" width="448" height="36"/><polygon points="6 238 0 238 0 244 0 256 0 274 448 274 448 256 448 244 448 238 442 238 6 238"/></svg>
        </label>
      </div>
      <input id="menu-toggle-1" class="hide" type="checkbox">
      <div id="nav-menus-main" class="nav__menus">
        <a href="../../programing.html">Programing</a>
        <a href="../../infra.html">Infrastructure</a>
        <a href="../../data.html">Data Processing</a>
        <a href="../../life.html">Life is like chocolate</a>
      </div>
    </div>
    <input id="menu-toggle-2" class="hide" type="checkbox">
    <div id="nav-menus-right" class="nav__content__right">
      <a href="../../about.html">About</a>
    </div>
  </div>
</div><div id="crumb-bar" class="cbb b6">
  <div class="cbb__content max-width-md">
    <div class="left-part">
      <div class="breadcrumb-item">
        <a href="../..//">Home</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <a href="../.././toc.html">Table of Contents</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>

      <div class="breadcrumb-item">
        <a href="../../programing.html">Programing</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <a href="../python.html">Python</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <span>encryption and decryption in python</span>
      </div>

    </div>
    <div class="right-part">
      <div class="search-field">
        <img class="icon-search" src="../../images/icon-search-gray.svg" alt="icon search gray">
        <input id="breadcrumb-search-box" class="search-box" type="search" placeholder="Search... (double â‡§)">
      </div>
      <img id="back-to-top" src="../../images/icon-top-darkgray.svg" title="Back to Top" alt="icon top darkgray">
    </div>
  </div>
</div><div class="c-title b7">
  <div class="c-title__content max-width-md">
    <h1>encryption and decryption in python</h1>
    <div class="meta">
      <img class="avatar" src="../../images/default-avatar.jpg" alt="Ivan" title="Ivan">
      <a class="author">Ivan</a>
      <span class="meta-divider">/</span>
      <span class="updated">28 Jun 2021 20:03:52</span>
    </div>
  </div>
</div><div class="c-article b8">
  <div class="c-article__content max-width-sm">
    <div id="article-body" class="article-body">
      <p>Recently I need to design a way to store and transfer sensitive data in a secure way, as the data is sensitive, no one could see the data except the owner, our system is only granted to get the plain text at run time, when storing or transferring the data, it must remains encrypted and the password for encryption should be encrypted as well, we also requested not use any hard coded password to do encryption and decryption</p>
<p><figure><img src="../../images/Encryption-Decryption.png" alt="Encryption-Decryption"></figure></p>
<p>there are 2 types of encryption mechanisms <code>Symmetric encryption</code> and <code>Asymmetric encryption</code>, Symmetric encryption uses a private key to encrypt and decrypt, Asymmetric encryption uses the public key of the recipient to encrypt the message. Then if the recipient wants to decrypt the message the recipient will have to use his/her private key to decrypt, we could tell, Asymmetric encryption is safer than Symmetric encryption, but it's not as efficient as Symmetric encryption and only suitable for small amount of data (e.g: key or password) encryption. https protocol is using the same way , it's using Asymmetric encryption to exchange the password, then use Symmetric encryption to exchange the actual content. I would like to do the same.</p>
<p>for Asymmetric encryption, we use <a href="https://simple.wikipedia.org/wiki/RSA_algorithm">RSA</a> algorithm, for Symmetric encryption, we use <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES-256</a> algorithm.  end user could provide us a pubkey and we could use the pubkey to encrypt any AES password and iv, for the actual content , for actual content, we could use AES-256 algorithm to encrypt the actual content and deliver &quot;rsa_encrypted_aes_password , rsa_encrypted_aes_iv , aes_encrypted_data&quot; to end user, when end user get the data, they could use their private key to decrypt <code>rsa_encrypted_aes_password</code> and <code>rsa_encrypted_aes_iv</code>, then use them to decrypt <code>aes_encrypted_data</code>.</p>
<p><a href="https://pypi.org/project/pycryptodome/">pycryptodome</a> provide out of box support for both RSA and AES algorithm</p>
<p>for RSA encryption and decryption, we could use code like below</p>
<pre><code>    from Crypto.Cipher import PKCS1_OAEP
    from Crypto.PublicKey import RSA
    
    def rsa_encrypt(original_data: bytes) -&gt; bytes:
        &quot;&quot;&quot;
        use cust_key to encrypt the data
        :return: base64 encoded encrypted str
        &quot;&quot;&quot;
        rsa_public_key = RSA.import_key(get_pubkey())
        cipher_rsa = PKCS1_OAEP.new(rsa_public_key)
        return cipher_rsa.encrypt(original_data)

    def rsa_decrypt(encrypted_content: bytes, private_key: bytes) -&gt; bytes:
        rsa_private_key = RSA.import_key(private_key)
        cipher_rsa = PKCS1_OAEP.new(rsa_private_key)
        return cipher_rsa.decrypt(encrypted_content)
</code></pre>
<p>for AES encryption and decryption, we could use code like below</p>
<pre><code>    from Crypto.Cipher import AES
    from Crypto.Util.Padding import pad, unpad
    def aes_encrypt(
        original_data: bytes,
        aes_secret: Optional[bytes] = None,
        aes_iv: Optional[bytes] = None,
    ) -&gt; Tuple[bytes, bytes, bytes]:
        &quot;&quot;&quot;
        use aes encrypt to encrypt the data
        :param original_data:
        :return: turple of (encrypted data in bytes, rsa encrypted aes_secret, rsa encrypted aes_iv
        &quot;&quot;&quot;
        # use aes-256-cbc 32*8=256 bit
        if not aes_secret:
            aes_secret = os.urandom(32)
        if not aes_iv:
            aes_iv = os.urandom(16)
        cipher = AES.new(aes_secret, AES.MODE_CBC, iv=aes_iv)
        # use default pkcs7 padding
        return (
            cipher.encrypt(pad(original_data, AES.block_size)),
            rsa_encrypt(aes_secret),
            rsa_encrypt(aes_iv),
        )

    def aes_decrypt(
        encrypted_content: bytes, aes_secret: bytes, aes_iv: bytes
    ) -&gt; bytes:
        cipher = AES.new(aes_secret, AES.MODE_CBC, iv=aes_iv)
        return unpad(cipher.decrypt(encrypted_content), AES.block_size)    
</code></pre>
<p>wait a second, there is 1 misleading point, we got user's pubkey and we need to store it somewhere in a secure way, store pubkey in a clear text may not be a good idea, so we decide to use KMS to encrypt the pubkey and put it into s3, with this we do not have any hard coded password and everything we store/transfer is encrypted by default<br />
for KMS encryption and decryption we could use <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/kms.html#KMS.Client.encrypt">boto3 kms client</a></p>
<p>to test kms, we could use <a href="https://github.com/spulec/moto">moto</a> , sample kms test could be found <a href="https://github.com/spulec/moto/blob/master/tests/test_kms/test_kms_boto3.py">https://github.com/spulec/moto/blob/master/tests/test_kms/test_kms_boto3.py</a></p>
    </div>
  </div>
</div>

<div id="disqus_thread" class="max-width-md"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://vipmind-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</body>
</html>
