<!DOCTYPE html>
<html>
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147718386-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147718386-1');
</script>


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mind - The python tool powers lambda</title>
  
    
  
  <meta name="description" content="aws-lambda-powertools-python is an useful toolset when you develop lambda functions in python, it contains several useful utilities to make lambda development easy. installation to install aws-lambda-powertools-python pip install aws-lambda-powertools I usually put it in requirements-test.txt because we could include t">
  
  
  
  <link rel="shortcut icon" href="../../images/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../../images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon/favicon-16x16.png">
  <link rel="manifest" href="../../images/favicon/site.webmanifest">
  <link rel="mask-icon" href="../../images/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  
  <link href='../../styles/main.min.css?v=1647256360756' rel='stylesheet' type='text/css'>
  
  <style></style>

  
<script>
  var doc_layout_plugin = {
    enabled: true
  };
</script>
</head>
<body>


<script async type="text/javascript" language="javascript" src="../../plugins/plugins.nocache.js?v=1647256360756"></script>
<iframe src="javascript:''" id="__gwt_historyFrame"
        style="position:absolute;width:0;height:0;border:0" tabIndex="-1"></iframe>
<!--[if lt IE 8]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<div class="nav b5">
  <div class="nav__content max-width-md">
    <div class="nav__content__left">
      <div class="nav__header">
        <a class="logo" href="../../index.html" title="Home">
          <img class="logo__img" src="../../images/logo.png" alt="VIP">
          <span class="logo__name">Mind</span><span class="superscript">me</span>
        </a>
        <label id="menu-icon" class="nav__menu-toggle" for="menu-toggle-1">
          <svg class="nav__menu-icon" viewBox="0 0 448 512"><rect y="398" width="448" height="36"/><rect y="78" width="448" height="36"/><polygon points="6 238 0 238 0 244 0 256 0 274 448 274 448 256 448 244 448 238 442 238 6 238"/></svg>
        </label>
      </div>
      <input id="menu-toggle-1" class="hide" type="checkbox">
      <div id="nav-menus-main" class="nav__menus">
        <a href="../../programing.html">Programing</a>
        <a href="../../infra.html">Infrastructure</a>
        <a href="../../data.html">Data Processing</a>
        <a href="../../life.html">Life is like chocolate</a>
      </div>
    </div>
    <input id="menu-toggle-2" class="hide" type="checkbox">
    <div id="nav-menus-right" class="nav__content__right">
      <a href="../../about.html">About</a>
    </div>
  </div>
</div><div id="crumb-bar" class="cbb b6">
  <div class="cbb__content max-width-md">
    <div class="left-part">
      <div class="breadcrumb-item">
        <a href="../..//">Home</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <a href="../.././toc.html">Table of Contents</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>

      <div class="breadcrumb-item">
        <a href="../../infra.html">Infra</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <a href="../aws.html">Aws</a>
        <img class="icon-arrow" src="../../images/icon-arrow-right-gray.svg" alt="icon arrow right gray">
      </div>
      <div class="breadcrumb-item">
        <span>The python tool powers lambda</span>
      </div>

    </div>
    <div class="right-part">
      <div class="search-field">
        <img class="icon-search" src="../../images/icon-search-gray.svg" alt="icon search gray">
        <input id="breadcrumb-search-box" class="search-box" type="search" placeholder="Search... (double â‡§)">
      </div>
      <img id="back-to-top" src="../../images/icon-top-darkgray.svg" title="Back to Top" alt="icon top darkgray">
    </div>
  </div>
</div><div class="c-title b7">
  <div class="c-title__content max-width-md">
    <h1>The python tool powers lambda</h1>
    <div class="meta">
      <img class="avatar" src="../../images/default-avatar.jpg" alt="Ivan" title="Ivan">
      <a class="author">Ivan</a>
      <span class="meta-divider">/</span>
      <span class="updated">10 Mar 2022 17:05:37</span>
    </div>
  </div>
</div><div class="c-article b8">
  <div class="c-article__content max-width-sm">
    <div id="article-body" class="article-body">
      <p><a href="https://awslabs.github.io/aws-lambda-powertools-python/">aws-lambda-powertools-python</a> is an useful toolset when you develop lambda functions in python, it contains several useful utilities to make lambda development easy.</p>
<p><figure><img src="../../images/lambda.png" alt="lambda"></figure></p>
<h2 id="installation-1">installation</h2>
<p>to install aws-lambda-powertools-python</p>
<pre><code>pip install aws-lambda-powertools
</code></pre>
<p>I usually put it in requirements-test.txt because we could include the package as a lambda layer</p>
<p>to include the lambda layer, in SAM template.yaml</p>
<pre><code>xxxEventListener:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: .
      Role: !Ref IAMRoleARN
      Handler: event_listener.handle
      Layers:
        - !Sub arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPython:11
</code></pre>
<h2 id="the-logger-2">the logger</h2>
<p>by default logger would not include python module name in the location field of log, if you are using multiple modules, you could override the log format as below</p>
<pre><code>from aws_lambda_powertools import Logger
location_format = &quot;%(module)s.%(funcName)s:%(lineno)d&quot;
logger = Logger(location=location_format)
</code></pre>
<p>then we could include the module information in the log record</p>
<p>we could also log the incoming event by just decorate handle method of the lambda</p>
<pre><code>@logger.inject_lambda_context(log_event=True)
def handle(event, context: LambdaContext):
  pass
</code></pre>
<p>if we set POWERTOOLS_LOGGER_SAMPLE_RATE as env var, the value is between 0 and 1, it indicate the chance that logger framework sample the log to debug level, it's very useful in production.</p>
<h2 id="the-tracer-3">the tracer</h2>
<p>we could trace the lambda handler by adding decorator to the method like below</p>
<pre><code>from aws_lambda_powertools import Tracer
tracer = Tracer()

@tracer.capture_lambda_handler
def handle(event, context: LambdaContext):
  pass
</code></pre>
<p>we could also decorate any method that we want to trace with</p>
<pre><code>@tracer.capture_method
def record_handler(record: SQSRecord):
</code></pre>
<p>we could then get trace detail from x-rays, the logger framework would include <code>xray_trace_id</code> in every log, so it's easy to locate the trace in x-ray with the id<br />
<figure><img src="../../images/lambda-xray.png" alt="lambda-xray"></figure></p>
<h2 id="the-batch-4">the batch</h2>
<p>when we use lambda to process message from sqs we will get a batch of messages (e.g 10 messages in a batch) , if any message failed to process, all the messages in this batch will be send back to sqs queue, with batch procsssing tool, we could just send back the failed message.<br />
when we attach a lambda function to a queue, make sure select &quot;ReportBatchItemFailures&quot; in Advanced options.</p>
<p>jupm into the code sample</p>
<pre><code>from aws_lambda_powertools.utilities.batch import (
    BatchProcessor,
    EventType,
    batch_processor,
)
from aws_lambda_powertools.utilities.data_classes.sqs_event import SQSRecord
from aws_lambda_powertools.utilities.typing import LambdaContext

processor = BatchProcessor(event_type=EventType.SQS)

@batch_processor(record_handler=record_handler, processor=processor)
def handle(event, context: LambdaContext):
    return processor.response()


def record_handler(record: SQSRecord):
    # logic to handle 1 sqs record
    pass

</code></pre>
<h2 id="the-parameter-store-5">the parameter store</h2>
<p>one way to manage lambda parameter is to use AWS ssm, we could store the parameter in a tree like structure, e.g:</p>
<pre><code>/app/env/system/key1=val1
/app/env/system/key2=val2
</code></pre>
<p>there are 2 ways to access these value from lambda</p>
<h3 id="option-1-6">option 1</h3>
<p>declare the key in sam parameter</p>
<pre><code>Parameters:
  Key1:
    Description: the key 1 desc
    Type: AWS::SSM::Parameter::Value&lt;String&gt;
    Default: /app/env/system/key1
</code></pre>
<p>when we deploy the sam application, parameter Key1's value will be replaced by val1</p>
<h3 id="option-2-7">option 2</h3>
<pre><code>from aws_lambda_powertools.utilities import parameters
value = parameters.get_parameter(&quot;/app/env/system/key1&quot;)

value will be &quot;val1&quot;

we could also retrieve a collection of items
items = parameters.get_parameters(&quot;/app/env/system&quot;)
for k, v in values.items():
  logger.debug(f&quot;{k} -&gt; {v})
</code></pre>
    </div>
  </div>
</div>

<div id="disqus_thread" class="max-width-md"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://vipmind-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</body>
</html>
